<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/%E8%A7%86%E5%8A%9B%E8%A1%A8%20(1).svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/%E8%A7%86%E5%8A%9B%E8%A1%A8.svg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dxzmpk.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Learning in Harbin Institute of Technology">
<meta property="og:type" content="website">
<meta property="og:title" content="董雄写字的地方">
<meta property="og:url" content="https://dxzmpk.github.io/">
<meta property="og:site_name" content="董雄写字的地方">
<meta property="og:description" content="Learning in Harbin Institute of Technology">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="董雄">
<meta property="article:tag" content="nlp">
<meta property="article:tag" content=" cs">
<meta property="article:tag" content=" hit">
<meta property="article:tag" content=" transformers">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://dxzmpk.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>董雄写字的地方</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">董雄写字的地方</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">endless hard working</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2021/03/29/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%92%8C%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E7%9A%84%E6%97%B6%E9%97%B4%E6%B6%88%E8%80%97%E5%AF%B9%E6%AF%94/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/29/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E5%92%8C%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E7%9A%84%E6%97%B6%E9%97%B4%E6%B6%88%E8%80%97%E5%AF%B9%E6%AF%94/" class="post-title-link" itemprop="url">快速排序和归并排序的时间消耗对比</a>
        </h2>

        <div class="post-meta">
          
            <i class="fa fa-thumb-tack"></i>
            <font color=7D26CD>置顶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-03-29 17:33:04 / 修改时间：18:26:39" itemprop="dateCreated datePublished" datetime="2021-03-29T17:33:04+08:00">2021-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/algorithm/" itemprop="url" rel="index"><span itemprop="name">algorithm</span></a>
                </span>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h1><p>快速排序和归并排序都基于递归的思想。其中归并排序每次将输入平均划分为两部分，因此时间复杂度为O(nlogn)。而快速排序根据选择的 pivot将其余的数据划分为大于s[pivot]和小于s[pivot]的，只有当s[pivot]恰好是中位数时，时间复杂度才是O(nlogn)，最坏情况下， 每次选择的pivot都位于边缘，如下图所示。这样时间复杂度就退化为$O(n^2)$</p>
<p><img src="\images\快速排序和归并排序的时间消耗对比\image-20210329182252736.png" alt="image-20210329182252736"></p>
<p>以上的分析是基于内存模型和大 O表示法的，而在实际运行过程中，由于归并排序归并需要的时间比快速排序时间长，因此时间的比较可能出现不一样的结果。本文将对其实际性能进行对比。本实验基于java 1.8。</p>
<h1 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h1><div class="table-container">
<table>
<thead>
<tr>
<th>数组长度</th>
<th>初始化情况</th>
<th>快速排序</th>
<th>归并排序</th>
<th>System</th>
</tr>
</thead>
<tbody>
<tr>
<td>1e6</td>
<td>有序</td>
<td>StackOverflow</td>
<td>496</td>
<td>5</td>
</tr>
<tr>
<td>1e6</td>
<td>无序</td>
<td>153</td>
<td>663</td>
<td>180</td>
</tr>
<tr>
<td>1e8</td>
<td>有序</td>
<td>StackOverflow</td>
<td>496</td>
<td>131</td>
</tr>
<tr>
<td>1e6</td>
<td>无序</td>
<td>17380</td>
<td>too long</td>
<td>17471</td>
</tr>
</tbody>
</table>
</div>
<p><strong><em>时间单位：ms</em></strong></p>
<h1 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h1><h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuickSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] s = <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;<span class="number">4</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">4</span>&#125;;</span><br><span class="line">        <span class="keyword">new</span> QuickSort().quickSort(s, <span class="number">0</span>, s.length - <span class="number">1</span>);</span><br><span class="line">        System.out.println(Arrays.toString(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(<span class="keyword">int</span>[] s, <span class="keyword">int</span> l, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> p;</span><br><span class="line">        <span class="keyword">if</span> (h - l &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            p = parition(s, l, h);</span><br><span class="line">            quickSort(s,l,p-<span class="number">1</span>);</span><br><span class="line">            quickSort(s,p+<span class="number">1</span>,h);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">parition</span><span class="params">(<span class="keyword">int</span>[] s, <span class="keyword">int</span> l, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i; <span class="comment">/* counter */</span></span><br><span class="line">        <span class="keyword">int</span> p; <span class="comment">/* pivot element index */</span></span><br><span class="line">        <span class="keyword">int</span> firsthigh; <span class="comment">/* next position to store lowest num */</span></span><br><span class="line"></span><br><span class="line">        p = h;</span><br><span class="line">        firsthigh = l;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = l; i &lt; h; i ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[i] &lt; s[p]) &#123;</span><br><span class="line">                swap(s, i, firsthigh);</span><br><span class="line">                firsthigh ++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        swap(s, p , firsthigh);</span><br><span class="line">        <span class="keyword">return</span> (firsthigh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] s, <span class="keyword">int</span> i, <span class="keyword">int</span> i1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> temp = s[i];</span><br><span class="line">        s[i] = s[i1];</span><br><span class="line">        s[i1] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] s = <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;<span class="number">4</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">4</span>&#125;;</span><br><span class="line">        <span class="keyword">new</span> MergeSort().mergesort(s, <span class="number">0</span>, s.length - <span class="number">1</span>);</span><br><span class="line">        System.out.println(Arrays.toString(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mergesort</span><span class="params">(<span class="keyword">int</span>[] s, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i; <span class="comment">/* counter */</span></span><br><span class="line">        <span class="keyword">int</span> middle; <span class="comment">/* index of middle element */</span></span><br><span class="line">        <span class="keyword">if</span> (low &lt; high) &#123;</span><br><span class="line">            middle = (low+high)/<span class="number">2</span>;</span><br><span class="line">            mergesort(s,low,middle);</span><br><span class="line">            mergesort(s,middle+<span class="number">1</span>,high);</span><br><span class="line">            merge(s, low, middle, high);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span>[] s, <span class="keyword">int</span> low, <span class="keyword">int</span> middle, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i; <span class="comment">// counter</span></span><br><span class="line">        Queue&lt;Integer&gt; buffer1, buffer2;</span><br><span class="line">        buffer1 = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        buffer2 = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (i = low; i &lt;= middle; i++) &#123;</span><br><span class="line">            buffer1.offer(s[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = middle + <span class="number">1</span>; i &lt;= high; i++) &#123;</span><br><span class="line">            buffer2.offer(s[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        i = low;</span><br><span class="line">        <span class="keyword">while</span> ((!buffer1.isEmpty()) &amp;&amp; (!buffer2.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (buffer1.peek() &lt;= buffer2.peek()) &#123; <span class="comment">// equals keeps stability</span></span><br><span class="line">                s[i++] = buffer1.poll();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                s[i++] = buffer2.poll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!buffer1.isEmpty()) &#123;</span><br><span class="line">            s[i++] = buffer1.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!buffer2.isEmpty()) &#123;</span><br><span class="line">            s[i++] = buffer2.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/11/28/%E6%9C%80%E5%B8%B8%E8%AE%BF%E9%97%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/28/%E6%9C%80%E5%B8%B8%E8%AE%BF%E9%97%AE/" class="post-title-link" itemprop="url">最常访问</a>
        </h2>

        <div class="post-meta">
          
            <i class="fa fa-thumb-tack"></i>
            <font color=7D26CD>置顶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-28 15:13:02 / 修改时间：15:15:07" itemprop="dateCreated datePublished" datetime="2020-11-28T15:13:02+08:00">2020-11-28</time>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-HuggingFace-Transformers系列的介绍以及在下游任务中的使用"><a href="#1-HuggingFace-Transformers系列的介绍以及在下游任务中的使用" class="headerlink" title="1. HuggingFace-Transformers系列的介绍以及在下游任务中的使用"></a><a href="https://dxzmpk.github.io/2020/04/23/HuggingFace-transformers%E7%B3%BB%E5%88%97%E7%9A%84%E4%BB%8B%E7%BB%8D%E4%BB%A5%E5%8F%8A%E5%9C%A8%E4%B8%8B%E6%B8%B8%E4%BB%BB%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8/">1. HuggingFace-Transformers系列的介绍以及在下游任务中的使用</a></h1><h1 id="2-Bert系列伴生的新分词器"><a href="#2-Bert系列伴生的新分词器" class="headerlink" title="2. Bert系列伴生的新分词器"></a><a href="https://dxzmpk.github.io/2020/04/29/Bert%E7%B3%BB%E5%88%97%E4%BC%B4%E7%94%9F%E7%9A%84%E6%96%B0%E5%88%86%E8%AF%8D%E5%99%A8/">2. Bert系列伴生的新分词器</a></h1><h1 id="3-三行代码开启模型训练通知"><a href="#3-三行代码开启模型训练通知" class="headerlink" title="3. 三行代码开启模型训练通知"></a><a href="https://dxzmpk.github.io/2020/05/08/%E4%B8%89%E8%A1%8C%E4%BB%A3%E7%A0%81%E5%BC%80%E5%90%AF%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E9%80%9A%E7%9F%A5/">3. 三行代码开启模型训练通知</a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/11/26/process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/26/process/" class="post-title-link" itemprop="url">Android Studio中3个和构建相关的组件</a>
        </h2>

        <div class="post-meta">
          
            <i class="fa fa-thumb-tack"></i>
            <font color=7D26CD>置顶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-26 13:31:03 / 修改时间：15:00:43" itemprop="dateCreated datePublished" datetime="2020-11-26T13:31:03+08:00">2020-11-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="android-studio中3个和构建相关的组件"><a href="#android-studio中3个和构建相关的组件" class="headerlink" title="android studio中3个和构建相关的组件"></a>android studio中3个和构建相关的组件</h1><ol>
<li><p><strong>Gradle程序</strong>，这是和安卓独立的gradle系统，现在的版本号为6.5；</p>
<p>在项目中, gradle存储在gradle\wrapper\gradle-wrapper.properties文件中，以下载链接的方式存在。例如：<img src="/images/process/image-20201126135147962.png" alt="image-20201126135147962"></p>
<p>在构建中往往出现gradle下载不完全的问题，这时就会报错。打开<code>C:\Users\Administrator\.gradle\wrapper\dists</code>文件夹，就能看到不同版本的gradle文件。</p>
<p><img src="/images/process/image-20201126135349366.png" alt="image-20201126135349366"></p>
<p>我们可以直接到<code>gradle-wrapper.properties</code>指定的url下载压缩包并放到<code>C:\Users\Administrator\.gradle\wrapper\dists\gradle-5.6.4-bin\bxirm19lnfz6nurbatndyydux</code>类似的位置中。在启动构建时，android studio会自动解压并运行。</p>
</li>
<li><p><strong>android sdk build tools.</strong>这是安卓sdk中自带的构建工具。我们可以打开<img src="/images/process/image-20201126140235517.png" alt="image-20201126140235517">这个图标，选择SDK tools栏看到<img src="/images/process/image-20201126140333350.png" alt="image-20201126140333350"></p>
<p>即已经安卓了相应的SDK build tools工具。在项目中的<img src="/images/process/image-20201126140458210.png" alt="image-20201126140458210">文件指定了需要的版本。<img src="/images/process/image-20201126140536176.png" alt="image-20201126140536176">如这里是29.0.2。打开安卓sdk build-tools目录，如<code>C:\Users\Administrator\AppData\Local\Android\Sdk\build-tools</code>就可以看到工具的所有版本。当出现下载问题时，可以到<a href="https://androidsdkmanager.azurewebsites.net/Buildtools" target="_blank" rel="noopener">相应网站</a>下载需要的工具版本，解压后重命名放到sdk build-tools目录中，android studio会自动检测并使用。</p>
</li>
<li><p><strong>gradle plugin.</strong> 除了以上两种，安卓还提供了一个构建插件。其版本号规定在项目文件<img src="/images/process/image-20201126141054278.png" alt="image-20201126141054278">中。即对于全局项目，使用的gradle插件是相同的。在打开android studio的时候，往往会提示我们更新gradle插件版本，其实就是指的它。一般情况下，gradle插件并不会导致太大的问题。</p>
</li>
</ol>
<h2 id="gradle-plugin-和-Gradle程序的兼容问题"><a href="#gradle-plugin-和-Gradle程序的兼容问题" class="headerlink" title="gradle plugin 和 Gradle程序的兼容问题"></a>gradle plugin 和 <strong>Gradle程序</strong>的兼容问题</h2><p>下表列出了每个版本的Android Gradle插件所需的Gradle版本。 为了获得最佳性能，建议使用Gradle和插件的最新版本。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Plugin version</th>
<th style="text-align:left">Required Gradle version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1.0.0 - 1.1.3</td>
<td style="text-align:left">2.2.1 - 2.3</td>
</tr>
<tr>
<td style="text-align:left">1.2.0 - 1.3.1</td>
<td style="text-align:left">2.2.1 - 2.9</td>
</tr>
<tr>
<td style="text-align:left">1.5.0</td>
<td style="text-align:left">2.2.1 - 2.13</td>
</tr>
<tr>
<td style="text-align:left">2.0.0 - 2.1.2</td>
<td style="text-align:left">2.10 - 2.13</td>
</tr>
<tr>
<td style="text-align:left">2.1.3 - 2.2.3</td>
<td style="text-align:left">2.14.1+</td>
</tr>
<tr>
<td style="text-align:left">2.3.0+</td>
<td style="text-align:left">3.3+</td>
</tr>
<tr>
<td style="text-align:left">3.0.0+</td>
<td style="text-align:left">4.1+</td>
</tr>
<tr>
<td style="text-align:left">3.1.0+</td>
<td style="text-align:left">4.4+</td>
</tr>
<tr>
<td style="text-align:left">3.2.0 - 3.2.1</td>
<td style="text-align:left">4.6+</td>
</tr>
<tr>
<td style="text-align:left">3.3.0 - 3.3.3</td>
<td style="text-align:left">4.10.1+</td>
</tr>
<tr>
<td style="text-align:left">3.4.0 - 3.4.3</td>
<td style="text-align:left">5.1.1+</td>
</tr>
<tr>
<td style="text-align:left">3.5.0 - 3.5.4</td>
<td style="text-align:left">5.4.1+</td>
</tr>
<tr>
<td style="text-align:left">3.6.0 - 3.6.4</td>
<td style="text-align:left">5.6.4+</td>
</tr>
<tr>
<td style="text-align:left">4.0.0+</td>
<td style="text-align:left">6.1.1+</td>
</tr>
<tr>
<td style="text-align:left">4.1.0+</td>
<td style="text-align:left">6.5+</td>
</tr>
</tbody>
</table>
</div>
<h2 id="安卓程序的构建"><a href="#安卓程序的构建" class="headerlink" title="安卓程序的构建"></a>安卓程序的构建</h2><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><p><img src="https://developer.android.com/images/tools/studio/project-structure_2x.png" alt="img" style="zoom:50%;" /></p>
<p>安卓项目主要分为三个级别：</p>
<ol>
<li>Project级别：项目包含的所有文件</li>
<li>Module级别：例如app等模块，一个项目可以有多个模块。</li>
<li>代码模块，main文件夹下的所有文件。</li>
</ol>
<h3 id="build-gradle文件结构"><a href="#build-gradle文件结构" class="headerlink" title="build.gradle文件结构"></a>build.gradle文件结构</h3><p>主要包含两个文件：</p>
<ol>
<li><p>全局构建配置文件build.gradle(Project)</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        maven &#123;</span><br><span class="line">            url <span class="string">'https://maven.google.com/'</span></span><br><span class="line">            name <span class="string">'Google'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:3.6.1'</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        maven &#123;</span><br><span class="line">            url <span class="string">'https://maven.google.com/'</span></span><br><span class="line">            name <span class="string">'Google'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="string">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>位于根项目目录中的全局build.gradle文件定义了适用于项目中所有模块的构建配置。 </p>
<p>默认情况下，buildscript块定义项目中所有模块通用的Gradle存储库和依赖项。</p>
<p>allprojects块用来配置存储库和所有模块共用的依赖，例如第三方插件和库，默认情况下，这里只包括jcenter和maven存储库。</p>
<p>dependencies配置了gradle构建项目需要的依赖，关于版本的问题前文已经提到过了。</p>
</li>
<li><p>模块配置文件 build.gradle(Module)</p>
<p>位于模块的根目录中，主要用于配置其所在的特定模块。我们可以通过配置这些构建设置来提供自定义打包选项，例如其他构建类型和产品类型，并覆盖manifest或全局build.gradle文件中的设置。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The first line in the build configuration applies the Android plugin for</span></span><br><span class="line"><span class="comment"> * Gradle to this build and makes the android block available to specify</span></span><br><span class="line"><span class="comment"> * Android-specific build options.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The android block is where you configure all your Android-specific</span></span><br><span class="line"><span class="comment"> * build options.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * compileSdkVersion specifies the Android API level Gradle should use to</span></span><br><span class="line"><span class="comment">   * compile your app. This means your app can use the API features included in</span></span><br><span class="line"><span class="comment">   * this API level and lower.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  compileSdkVersion <span class="number">28</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * buildToolsVersion specifies the version of the SDK build tools, command-line</span></span><br><span class="line"><span class="comment">   * utilities, and compiler that Gradle should use to build your app. You need to</span></span><br><span class="line"><span class="comment">   * download the build tools using the SDK Manager.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This property is optional because the plugin uses a recommended version of</span></span><br><span class="line"><span class="comment">   * the build tools by default.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  buildToolsVersion <span class="string">"29.0.2"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The defaultConfig block encapsulates default settings and entries for all</span></span><br><span class="line"><span class="comment">   * build variants, and can override some attributes in main/AndroidManifest.xml</span></span><br><span class="line"><span class="comment">   * dynamically from the build system. You can configure product flavors to override</span></span><br><span class="line"><span class="comment">   * these values for different versions of your app.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  defaultConfig &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * applicationId uniquely identifies the package for publishing.</span></span><br><span class="line"><span class="comment">     * However, your source code should still reference the package name</span></span><br><span class="line"><span class="comment">     * defined by the package attribute in the main/AndroidManifest.xml file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    applicationId <span class="string">'com.example.myapp'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Defines the minimum API level required to run the app.</span></span><br><span class="line">    minSdkVersion <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Specifies the API level used to test the app.</span></span><br><span class="line">    targetSdkVersion <span class="number">28</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Defines the version number of your app.</span></span><br><span class="line">    versionCode <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Defines a user-friendly version name for your app.</span></span><br><span class="line">    versionName <span class="string">"1.0"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The buildTypes block is where you can configure multiple build types.</span></span><br><span class="line"><span class="comment">   * By default, the build system defines two build types: debug and release. The</span></span><br><span class="line"><span class="comment">   * debug build type is not explicitly shown in the default build configuration,</span></span><br><span class="line"><span class="comment">   * but it includes debugging tools and is signed with the debug key. The release</span></span><br><span class="line"><span class="comment">   * build type applies Proguard settings and is not signed by default.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  buildTypes &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By default, Android Studio configures the release build type to enable code</span></span><br><span class="line"><span class="comment">     * shrinking, using minifyEnabled, and specifies the default Proguard rules file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled <span class="literal">true</span> <span class="comment">// Enables code shrinking for the release build type.</span></span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The productFlavors block is where you can configure multiple product flavors.</span></span><br><span class="line"><span class="comment">   * This allows you to create different versions of your app that can</span></span><br><span class="line"><span class="comment">   * override the defaultConfig block with their own settings. Product flavors</span></span><br><span class="line"><span class="comment">   * are optional, and the build system does not create them by default.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This example creates a free and paid product flavor. Each product flavor</span></span><br><span class="line"><span class="comment">   * then specifies its own application ID, so that they can exist on the Google</span></span><br><span class="line"><span class="comment">   * Play Store, or an Android device, simultaneously.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * If you declare product flavors, you must also declare flavor dimensions</span></span><br><span class="line"><span class="comment">   * and assign each flavor to a flavor dimension.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  flavorDimensions <span class="string">"tier"</span></span><br><span class="line">  productFlavors &#123;</span><br><span class="line">    free &#123;</span><br><span class="line">      dimension <span class="string">"tier"</span></span><br><span class="line">      applicationId <span class="string">'com.example.myapp.free'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    paid &#123;</span><br><span class="line">      dimension <span class="string">"tier"</span></span><br><span class="line">      applicationId <span class="string">'com.example.myapp.paid'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The splits block is where you can configure different APK builds that</span></span><br><span class="line"><span class="comment">   * each contain only code and resources for a supported screen density or</span></span><br><span class="line"><span class="comment">   * ABI. You'll also need to configure your build so that each APK has a</span></span><br><span class="line"><span class="comment">   * different versionCode.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  splits &#123;</span><br><span class="line">    <span class="comment">// Settings to build multiple APKs based on screen density.</span></span><br><span class="line">    density &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Enable or disable building multiple APKs.</span></span><br><span class="line">      enable <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Exclude these densities when building multiple APKs.</span></span><br><span class="line">      exclude <span class="string">"ldpi"</span>, <span class="string">"tvdpi"</span>, <span class="string">"xxxhdpi"</span>, <span class="string">"400dpi"</span>, <span class="string">"560dpi"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The dependencies block in the module-level build configuration file</span></span><br><span class="line"><span class="comment"> * specifies dependencies required to build only the module itself.</span></span><br><span class="line"><span class="comment"> * To learn more, go to Add build dependencies.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation project(<span class="string">":lib"</span>)</span><br><span class="line">    implementation <span class="string">'com.android.support:appcompat-v7:28.0.0'</span></span><br><span class="line">    implementation fileTree(<span class="string">dir:</span> <span class="string">'libs'</span>, <span class="string">include:</span> [<span class="string">'*.jar'</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://developer.android.com/studio/build" target="_blank" rel="noopener">https://developer.android.com/studio/build</a></p>
<p><a href="https://developer.android.com/codelabs/android-training-hello-world?index=..%2F..%2Fandroid-training#0" target="_blank" rel="noopener">https://developer.android.com/codelabs/android-training-hello-world?index=..%2F..%2Fandroid-training#0</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/04/23/HuggingFace-transformers%E7%B3%BB%E5%88%97%E7%9A%84%E4%BB%8B%E7%BB%8D%E4%BB%A5%E5%8F%8A%E5%9C%A8%E4%B8%8B%E6%B8%B8%E4%BB%BB%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/23/HuggingFace-transformers%E7%B3%BB%E5%88%97%E7%9A%84%E4%BB%8B%E7%BB%8D%E4%BB%A5%E5%8F%8A%E5%9C%A8%E4%B8%8B%E6%B8%B8%E4%BB%BB%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">HuggingFace-Transformers系列的介绍以及在下游任务中的使用</a>
        </h2>

        <div class="post-meta">
          
            <i class="fa fa-thumb-tack"></i>
            <font color=7D26CD>置顶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-23 09:02:46" itemprop="dateCreated datePublished" datetime="2020-04-23T09:02:46+08:00">2020-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-26 14:47:55" itemprop="dateModified" datetime="2020-11-26T14:47:55+08:00">2020-11-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nlp/" itemprop="url" rel="index"><span itemprop="name">nlp</span></a>
                </span>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="内容介绍"><a href="#内容介绍" class="headerlink" title="内容介绍"></a>内容介绍</h1><p>这篇博客主要面向对<strong>Bert</strong>系列在<strong>Pytorch</strong>上应用感兴趣的同学，将涵盖的主要内容是：Bert系列有关的论文，<a href="https://huggingface.co/transformers/installation.html#" target="_blank" rel="noopener">Huggingface</a>的实现，以及如何在不同下游任务中使用预训练模型。</p>
<p>看过这篇博客，你将了解：</p>
<ul>
<li>Transformers实现的介绍，不同的Tokenizer和Model如何使用。</li>
<li>如何利用HuggingFace的实现自定义你的模型，如果你想利用这个库实现自己的下游任务，而不想过多关注其实现细节的话，那么这篇文章将会成为很好的参考。 </li>
</ul>
<h2 id="Huggingface-transformers介绍"><a href="#Huggingface-transformers介绍" class="headerlink" title="Huggingface-transformers介绍"></a>Huggingface-transformers介绍</h2><p><a href="https://huggingface.co/transformers/index.html" target="_blank" rel="noopener">transformers</a>（以前称为pytorch-transformers和pytorch-pretrained-bert）提供用于自然语言理解（NLU）和自然语言生成（NLG）的BERT家族通用结构（BERT，GPT-2，RoBERTa，XLM，DistilBert，XLNet等），包含超过32种、涵盖100多种语言的预训练模型。同时提供TensorFlow 2.0和PyTorch之间的高互通性。</p>
<p><strong>特性</strong>：</p>
<ul>
<li><p>与pytorch-transformers一样易于使用</p>
</li>
<li><p>像Keras一样强大而简洁</p>
</li>
<li><p>在NLU和NLG任务上表现良好</p>
</li>
<li><p>对于教育者和从业者的门槛低</p>
</li>
</ul>
<p><strong>现存的模型</strong>：</p>
<ul>
<li><p>Bert(基础版和巨人版, 是否区分大小写)， </p>
</li>
<li><p>GPT, GPT-2</p>
</li>
<li><p>Transformer-XL, XLNet, XLM</p>
</li>
<li><p>DistilBERT, DistilGPT2</p>
</li>
<li><p>CTRL</p>
</li>
<li><p>ALBERT, RoBERTa, XLM-RoBERTa</p>
</li>
<li><p>FlauBERT，CamemBERT</p>
</li>
<li>其他在各种下游任务上微调过的模型。</li>
<li>在多语言上训练的模型</li>
</ul>
<h1 id="所需的知识"><a href="#所需的知识" class="headerlink" title="所需的知识"></a>所需的知识</h1><p><a href="https://huggingface.co/transformers/installation.html#" target="_blank" rel="noopener">安装Huggface库</a>(需要预先安装pytorch)</p>
<p>在阅读这篇文章之前，如果你能将以下资料读一遍，或者看一遍的话，在后续的阅读过程中将极大地减少你陷入疑惑的概率。</p>
<ul>
<li>视频类内容：根据排序观看更佳<ul>
<li><a href="https://www.bilibili.com/video/BV17441137fa?from=search&amp;seid=17871853660365597030" target="_blank" rel="noopener">李宏毅关于Elmo, Bert, GPT的讲解</a></li>
<li><a href="https://www.bilibili.com/video/BV1Tt411M7Wp?from=search&amp;seid=194654766718455422" target="_blank" rel="noopener">Goebels关于transformerXL的讲解</a></li>
<li><a href="https://www.youtube.com/watch?v=H5vpBCLo74U" target="_blank" rel="noopener">Kilcher关于XLnet的讲解</a></li>
<li><a href="https://www.youtube.com/watch?v=vsGN8WqwvKg&amp;t=597s" target="_blank" rel="noopener">McCormick关于ALBERT的讲解</a></li>
</ul>
</li>
</ul>
<p><strong>或者</strong>，你更愿意去看论文的话：</p>
<ul>
<li>相关论文：根据排序阅读更佳<ul>
<li><a href="https://arxiv.org/abs/1810.04805" target="_blank" rel="noopener">BERT论文</a>, BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding, Authors: Jacob Devlin, Ming-Wei Chang, Kenton Lee, Kristina Toutanova</li>
<li><a href="https://arxiv.org/abs/1901.02860" target="_blank" rel="noopener">Transformer-XL论文</a>, Transformer-XL: Attentive Language Models Beyond a Fixed-Length Context,  Authors: Zihang Dai, Zhilin Yang, Yiming Yang, William W. Cohen, Jaime Carbonell, Quoc V. Le and Ruslan Salakhutdinov.</li>
<li><a href="http://xxx.itp.ac.cn/abs/1906.08237" target="_blank" rel="noopener">XLNet论文</a>，XLNet: Generalized Autoregressive Pretraining for Language Understanding</li>
<li><a href="http://xxx.itp.ac.cn/abs/1909.11942" target="_blank" rel="noopener">ALBERT论文</a>，ALBERT: A Lite BERT for Self-supervised Learning of Language Representations</li>
<li><a href="http://xxx.itp.ac.cn/abs/1907.11692" target="_blank" rel="noopener">RoBERTa论文</a>， RoBERTa: A Robustly Optimized BERT Pretraining Approach</li>
<li><a href="http://xxx.itp.ac.cn/abs/1910.01108" target="_blank" rel="noopener">DistilBERT论文</a>，DistilBERT, a distilled version of BERT: smaller, faster, cheaper and lighter</li>
</ul>
</li>
</ul>
<h1 id="HuggingFace模型加载-下游任务使用"><a href="#HuggingFace模型加载-下游任务使用" class="headerlink" title="HuggingFace模型加载+下游任务使用"></a>HuggingFace模型加载+下游任务使用</h1><h2 id="项目组件"><a href="#项目组件" class="headerlink" title="项目组件"></a>项目组件</h2><p>一个完整的transformer模型主要包含三部分：</p>
<ol>
<li><p><strong>Config</strong>，控制模型的名称、最终输出的样式、隐藏层宽度和深度、激活函数的类别等。将Config类导出时文件格式为 json格式，就像下面这样：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"attention_probs_dropout_prob"</span>: <span class="number">0.1</span>,</span><br><span class="line">  <span class="attr">"hidden_act"</span>: <span class="string">"gelu"</span>,</span><br><span class="line">  <span class="attr">"hidden_dropout_prob"</span>: <span class="number">0.1</span>,</span><br><span class="line">  <span class="attr">"hidden_size"</span>: <span class="number">768</span>,</span><br><span class="line">  <span class="attr">"initializer_range"</span>: <span class="number">0.02</span>,</span><br><span class="line">  <span class="attr">"intermediate_size"</span>: <span class="number">3072</span>,</span><br><span class="line">  <span class="attr">"max_position_embeddings"</span>: <span class="number">512</span>,</span><br><span class="line">  <span class="attr">"num_attention_heads"</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">"num_hidden_layers"</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">"type_vocab_size"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"vocab_size"</span>: <span class="number">30522</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，也可以通过config.json来实例化Config类，这是一个互逆的过程。</p>
</li>
<li><p><strong>Tokenizer</strong>，这是一个将纯文本转换为编码的过程。注意，Tokenizer并不涉及将词转化为词向量的过程，仅仅是将纯文本分词，添加[MASK]标记、[SEP]、[CLS]标记，并转换为字典索引。Tokenizer类导出时将分为三个文件，也就是：</p>
<ul>
<li><p>vocab.txt</p>
<p>词典文件，每一行为一个词或词的一部分</p>
</li>
<li><p>special_tokens_map.json 特殊标记的定义方式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"unk_token"</span>: <span class="string">"[UNK]"</span>, <span class="attr">"sep_token"</span>: <span class="string">"[SEP]"</span>, <span class="attr">"pad_token"</span>: <span class="string">"[PAD]"</span>, </span><br><span class="line"> <span class="attr">"cls_token"</span>: <span class="string">"[CLS]"</span>, <span class="attr">"mask_token"</span>: <span class="string">"[MASK]"</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>tokenizer_config.json 配置文件，主要存储特殊的配置。</p>
</li>
</ul>
</li>
<li><p><strong>Model</strong>，也就是各种各样的模型。除了初始的Bert、GPT等基本模型，针对下游任务，还定义了诸如<code>BertForQuestionAnswering</code>等下游任务模型。模型导出时将生成<code>config.json</code>和<code>pytorch_model.bin</code>参数文件。前者就是1中的配置文件，这和我们的直觉相同，即config和model应该是紧密联系在一起的两个类。后者其实和torch.save()存储得到的文件是相同的，这是因为Model都直接或者间接继承了Pytorch的Module类。从这里可以看出，HuggingFace在实现时很好地尊重了Pytorch的原生API。</p>
</li>
</ol>
<h2 id="导入Bert系列基本模型的方法"><a href="#导入Bert系列基本模型的方法" class="headerlink" title="导入Bert系列基本模型的方法"></a>导入Bert系列基本模型的方法</h2><h3 id="通过官网自动导入"><a href="#通过官网自动导入" class="headerlink" title="通过官网自动导入"></a>通过官网自动导入</h3><p>官方文档中<a href="https://huggingface.co/transformers/quickstart.html#" target="_blank" rel="noopener">初始教程</a>提供的方法为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from transformers import BertModel</span></span><br><span class="line"><span class="comment"># Load pre-trained model (weights)</span></span><br><span class="line"><span class="comment"># model = BertModel.from_pretrained('bert-base-uncased')</span></span><br></pre></td></tr></table></figure>
<p>这个方法需要从官方的s3数据库下载模型配置、参数等信息（代码中已配置好位置）。这个方法虽然简单，但是在国内并不可用。当然你可以先尝试一下，不过会有很大的概率无法下载模型。</p>
<h3 id="手动下载模型信息并导入"><a href="#手动下载模型信息并导入" class="headerlink" title="手动下载模型信息并导入"></a>手动下载模型信息并导入</h3><ol>
<li><p>在HuggingFace<a href="https://huggingface.co/models" target="_blank" rel="noopener">官方模型库</a>上找到需要下载的模型，点击模型链接， 这个例子使用的是bert-base-uncased模型</p>
</li>
<li><p>点击<a href="https://huggingface.co/bert-base-uncased#" target="_blank" rel="noopener">List all files in model</a>，将其中的文件一一下载到同一目录中。例如，对于XLNet:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># List of model files</span><br><span class="line">config.json	782.0B</span><br><span class="line">pytorch_model.bin	445.4MB</span><br><span class="line">special_tokens_map.json	202.0B</span><br><span class="line">spiece.model	779.3KB</span><br><span class="line">tokenizer_config.json	2.0B</span><br></pre></td></tr></table></figure>
<p>但是这种方法有时也会不可用。如果您可以将Transformers预训练模型上传到迅雷等网盘的话，请在评论区告知，我会添加在此博客中，并为您添加博客友链。</p>
</li>
<li><p>通过下载好的路径导入模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> transformers</span><br><span class="line">MODEL_PATH = <span class="string">r"D:\transformr_files\bert-base-uncased/"</span></span><br><span class="line"><span class="comment"># a.通过词典导入分词器</span></span><br><span class="line">tokenizer = transformers.BertTokenizer.from_pretrained(<span class="string">r"D:\transformr_files\bert-base-uncased\bert-base-uncased-vocab.txt"</span>) </span><br><span class="line"><span class="comment"># b. 导入配置文件</span></span><br><span class="line">model_config = transformers.BertConfig.from_pretrained(MODEL_PATH)</span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">model_config.output_hidden_states = <span class="literal">True</span></span><br><span class="line">model_config.output_attentions = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 通过配置和路径导入模型</span></span><br><span class="line">model = transformers.BertModel.from_pretrained(MODEL_PATH,config = model_config)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="利用分词器分词"><a href="#利用分词器分词" class="headerlink" title="利用分词器分词"></a>利用分词器分词</h3><p>利用分词器进行编码</p>
<ul>
<li><p>对于单句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encode仅返回input_ids</span></span><br><span class="line">tokenizer.encode(<span class="string">"i like you"</span>)</span><br><span class="line">Out : [<span class="number">101</span>, <span class="number">1045</span>, <span class="number">2066</span>, <span class="number">2017</span>, <span class="number">102</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>对于多句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encode_plus返回所有编码信息</span></span><br><span class="line">sen_code = tokenizer.encode_plus(<span class="string">"i like you"</span>, <span class="string">"but not him"</span>)</span><br><span class="line">Out : </span><br><span class="line">    &#123;<span class="string">'input_ids'</span>: [<span class="number">101</span>, <span class="number">1045</span>, <span class="number">2066</span>, <span class="number">2017</span>, <span class="number">102</span>, <span class="number">2021</span>, <span class="number">2025</span>, <span class="number">2032</span>, <span class="number">102</span>],</span><br><span class="line">     <span class="string">'token_type_ids'</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">     <span class="string">'attention_mask'</span>: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>模型的所有分词器都是在PreTrainedTokenizer中实现的，分词的结果主要有以下内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">input_ids: list[int],</span><br><span class="line">token_type_ids: list[int] if return_token_type_ids is True (default)</span><br><span class="line">attention_mask: list[int] if return_attention_mask is True (default)</span><br><span class="line">overflowing_tokens: list[int] if a max_length is specified and 		return_overflowing_tokens is True</span><br><span class="line">num_truncated_tokens: int if a max_length is specified and return_overflowing_tokens is True</span><br><span class="line">special_tokens_mask: list[int] if add_special_tokens if set to True and return_special_tokens_mask is True</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编码解释：</p>
<ul>
<li>‘input_ids’：顾名思义，是单词在词典中的编码</li>
<li>‘token_type_ids’， 区分两个句子的编码</li>
<li>‘attention_mask’,  指定对哪些词进行self-Attention操作</li>
<li>‘overflowing_tokens’, 当指定最大长度时，溢出的单词</li>
<li>‘num_truncated_tokens’, 溢出的token数量</li>
<li>‘return_special_tokens_mask’，如果添加特殊标记，则这是[0，1]的列表，其中0指定特殊添加的标记，而1指定序列标记</li>
</ul>
<h3 id="将input-ids转化回token"><a href="#将input-ids转化回token" class="headerlink" title="将input_ids转化回token"></a>将input_ids转化回token</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tokenizer.convert_ids_to_tokens(sen_code[<span class="string">'input_ids'</span>])</span><br></pre></td></tr></table></figure>
<p>得到的结果是：</p>
<p><code>[&#39;[CLS]&#39;, &#39;i&#39;, &#39;like&#39;, &#39;you&#39;, &#39;[SEP]&#39;, &#39;but&#39;, &#39;not&#39;, &#39;him&#39;, &#39;[SEP]&#39;]</code></p>
<p>即tokenizer在编码时已经默认添加了标记。各模型对应的输入格式是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bert:       [CLS] + tokens + [SEP] + padding</span><br><span class="line"></span><br><span class="line">roberta:    [CLS] + prefix_space + tokens + [SEP] + padding</span><br><span class="line"></span><br><span class="line">distilbert: [CLS] + tokens + [SEP] + padding</span><br><span class="line"></span><br><span class="line">xlm:        [CLS] + tokens + [SEP] + padding</span><br><span class="line"></span><br><span class="line">xlnet:      padding + tokens + [SEP] + [CLS]</span><br></pre></td></tr></table></figure>
<p>其中<code>[CLS]</code>对应分类等任务中的标记，<code>[SEP]</code>对应句子的结束，padding是当指定模型最大输入长度max_len时，需要补充的字符。</p>
<h3 id="对编码进行转换，以便输入Tensor"><a href="#对编码进行转换，以便输入Tensor" class="headerlink" title="对编码进行转换，以便输入Tensor"></a>对编码进行转换，以便输入Tensor</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">model.eval() <span class="comment"># 将模型设为验证模式</span></span><br><span class="line">input_ids = torch.tensor([sen_code[<span class="string">'input_ids'</span>]]) <span class="comment"># 添加batch维度并转化为tensor</span></span><br><span class="line">token_type_ids = torch.tensor([sen_code[<span class="string">'token_type_ids'</span>]])</span><br></pre></td></tr></table></figure>
<h3 id="将分词结果输入模型，得到编码"><a href="#将分词结果输入模型，得到编码" class="headerlink" title="将分词结果输入模型，得到编码"></a>将分词结果输入模型，得到编码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将模型转化为eval模式</span></span><br><span class="line">model.eval()</span><br><span class="line"><span class="comment"># 将模型和数据转移到cuda, 若无cuda,可更换为cpu</span></span><br><span class="line">device = <span class="string">'cuda'</span></span><br><span class="line">tokens_tensor = input_ids.to(device)</span><br><span class="line">segments_tensors = token_type_ids.to(device)</span><br><span class="line">model.to(device)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行编码</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="comment"># See the models docstrings for the detail of the inputs</span></span><br><span class="line">    outputs = model(tokens_tensor, token_type_ids=segments_tensors)</span><br><span class="line">    <span class="comment"># Transformers models always output tuples.</span></span><br><span class="line">    <span class="comment"># See the models docstrings for the detail of all the outputs</span></span><br><span class="line">    <span class="comment"># In our case, the first element is the hidden state of the last layer of the Bert model</span></span><br><span class="line">    encoded_layers = outputs</span><br><span class="line"><span class="comment"># 得到最终的编码结果encoded_layers</span></span><br></pre></td></tr></table></figure>
<p>Bert最终输出的结果为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sequence_output, pooled_output, (hidden_states), (attentions)</span><br></pre></td></tr></table></figure>
<p>以输入序列长度为14为例</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>index</th>
<th>名称</th>
<th>维度</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>sequence_output</td>
<td>torch.Size([1, 14, 768])</td>
<td>输出序列</td>
</tr>
<tr>
<td>1</td>
<td>pooled_output</td>
<td>torch.Size([1, 768])</td>
<td>对输出序列进行pool操作的结果</td>
</tr>
<tr>
<td>2</td>
<td>(hidden_states)</td>
<td>tuple,13*torch.Size([1, 14, 768])</td>
<td>隐藏层状态(包括Embedding层)，取决于modelconfig中output_hidden_states</td>
</tr>
<tr>
<td>3</td>
<td>(attentions)</td>
<td>tuple,12*torch.Size([1, 12, 14, 14])</td>
<td>注意力层，取决于参数中output_attentions</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Bert总结"><a href="#Bert总结" class="headerlink" title="Bert总结"></a>Bert总结</h3><p>这一节我们以Bert为例对模型整体的流程进行了了解。之后的很多模型都基于Bert，并基于Bert进行了少量的调整。其中的输出和输出参数也有很多重复的地方。</p>
<h2 id="利用预训练模型在下游任务上微调"><a href="#利用预训练模型在下游任务上微调" class="headerlink" title="利用预训练模型在下游任务上微调"></a>利用预训练模型在下游任务上微调</h2><p>如开头所说，这篇文章重点在于”如何进行模型的调整以及输入输出的设定”, 以及”Transformer的实现进行简要的提及”, 所以，我们不会去介绍、涉及如何写train循环等话题，而仅仅专注于模型。也就是说，我们将止步于跑通一个模型，而不计批量数据预处理、训练、验证等过程。</p>
<p>同时，这里更看重如何基于Bert等初始模型在实际任务上进行微调，所以我们不会仅仅地导入已经在下游任务上训练好的模型参数，因为在这些模型上使用的方法和上一章的几乎完全相同。</p>
<p>这里的输入和输入以模型的预测过程为例。</p>
<h3 id="问答任务-via-Bert"><a href="#问答任务-via-Bert" class="headerlink" title="问答任务 via Bert"></a>问答任务 via Bert</h3><p><strong>任务输入</strong>：问题句，答案所在的文章 <code>&quot;Who was Jim Henson?&quot;, &quot;Jim Henson was a nice puppet&quot;</code></p>
<p><strong>任务输出</strong>：答案  <code>&quot;a nice puppet&quot;</code></p>
<p>现存的模型输入输出和任务的输入输出有一定差别，这也是在使用上需要区别的地方：</p>
<p><strong>模型输入</strong>：inputids, token_type_ids</p>
<p><strong>模型输出</strong>：start_scores, end_scores 形状都为<code>torch.Size([1, 14])</code>,其中<code>14</code>为序列长度，代表每个位置是开始/结束位置的概率。</p>
<p><strong>模型的构建</strong>：</p>
<p>一般情况下，一个基本模型对应一个Tokenizer, 所以并不存在对应于具体下游任务的Tokenizer。这里通过bert_model初始化BertForQuestionAnswering。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> BertTokenizer, BertForQuestionAnswering</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line">MODEL_PATH = <span class="string">r"D:\transformr_files\bert-base-uncased/"</span></span><br><span class="line"><span class="comment"># 实例化tokenizer</span></span><br><span class="line">tokenizer = BertTokenizer.from_pretrained(<span class="string">r"D:\transformr_files\bert-base-uncased\bert-base-uncased-vocab.txt"</span>)</span><br><span class="line"><span class="comment"># 导入bert的model_config</span></span><br><span class="line">model_config = transformers.BertConfig.from_pretrained(MODEL_PATH)</span><br><span class="line"><span class="comment"># 首先新建bert_model</span></span><br><span class="line">bert_model = transformers.BertModel.from_pretrained(MODEL_PATH,config = model_config)</span><br><span class="line"><span class="comment"># 最终有两个输出，初始位置和结束位置（下面有解释）</span></span><br><span class="line">model_config.num_labels = <span class="number">2</span></span><br><span class="line"><span class="comment"># 同样根据bert的model_config新建BertForQuestionAnswering</span></span><br><span class="line">model = BertForQuestionAnswering(model_config)</span><br><span class="line">model.bert = bert_model</span><br></pre></td></tr></table></figure>
<p><strong>利用模型进行运算：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设定模式</span></span><br><span class="line">model.eval()</span><br><span class="line">question, text = <span class="string">"Who was Jim Henson?"</span>, <span class="string">"Jim Henson was a nice puppet"</span></span><br><span class="line"><span class="comment"># 获取input_ids编码</span></span><br><span class="line">input_ids = tokenizer.encode(question, text)</span><br><span class="line"><span class="comment"># 手动进行token_type_ids编码，可用encode_plus代替</span></span><br><span class="line">token_type_ids = [<span class="number">0</span> <span class="keyword">if</span> i &lt;= input_ids.index(<span class="number">102</span>) <span class="keyword">else</span> <span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(len(input_ids))]</span><br><span class="line"><span class="comment"># 得到评分, </span></span><br><span class="line">start_scores, end_scores = model(torch.tensor([input_ids]), token_type_ids=torch.tensor([token_type_ids]))</span><br><span class="line"><span class="comment"># 进行逆编码，得到原始的token </span></span><br><span class="line">all_tokens = tokenizer.convert_ids_to_tokens(input_ids)</span><br><span class="line"><span class="comment">#['[CLS]', 'who', 'was', 'jim', 'henson', '?', '[SEP]', 'jim', 'henson', 'was', 'a', 'nice', 'puppet', '[SEP]']</span></span><br></pre></td></tr></table></figure>
<p><strong>将模型输出转化为任务输出：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对输出的答案进行解码的过程</span></span><br><span class="line">answer = <span class="string">' '</span>.join(all_tokens[torch.argmax(start_scores) : torch.argmax(end_scores)+<span class="number">1</span>])</span><br><span class="line"><span class="comment"># assert answer == "a nice puppet" </span></span><br><span class="line"><span class="comment"># 这里因为没有经过微调，所以效果不是很好，输出结果不佳。</span></span><br><span class="line">print(answer)</span><br><span class="line"><span class="comment"># 'was jim henson ? [SEP] jim henson was a nice puppet [SEP]'</span></span><br></pre></td></tr></table></figure>
<h3 id="文本分类任务-情感分析等-via-XLNet"><a href="#文本分类任务-情感分析等-via-XLNet" class="headerlink" title="文本分类任务(情感分析等) via XLNet"></a>文本分类任务(情感分析等) via XLNet</h3><p><strong>任务输入</strong>：句子 <code>&quot;i like you, what about you&quot;</code></p>
<p><strong>任务输出</strong>：句子所属的类别 <code>class1</code></p>
<p><strong>模型输入</strong>：inputids, token_type_ids</p>
<p><strong>模型输出</strong>：logits, hidden states， 其中logits形状为<code>torch.Size([1, 3])</code>, 其中的3对应的是类别的数量。当训练时，第一项为loss。</p>
<p><strong>模型的构建</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> XLNetConfig, XLNetModel, XLNetTokenizer, XLNetForSequenceClassification</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># 定义路径，初始化tokenizer</span></span><br><span class="line">XLN_PATH = <span class="string">r"D:\transformr_files\XLNetLMHeadModel"</span></span><br><span class="line">tokenizer = XLNetTokenizer.from_pretrained(XLN_PATH)</span><br><span class="line"><span class="comment"># 加载配置</span></span><br><span class="line">model_config = XLNetConfig.from_pretrained(XLN_PATH)</span><br><span class="line"><span class="comment"># 设定类别数为3</span></span><br><span class="line">model_config.num_labels = <span class="number">3</span></span><br><span class="line"><span class="comment"># 直接从xlnet的config新建XLNetForSequenceClassification(和上一节方法等效)</span></span><br><span class="line">cls_model = XLNetForSequenceClassification.from_pretrained(XLN_PATH, config=model_config)</span><br></pre></td></tr></table></figure>
<p><strong>利用模型进行运算：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设定模式</span></span><br><span class="line">model.eval()</span><br><span class="line">token_codes = tokenizer.encode_plus(<span class="string">"i like you, what about you"</span>)</span><br><span class="line"><span class="comment"># encode_plus结果为字典形式</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    outputs = cls_model(input_ids=torch.tensor([token_codes[<span class="string">'input_ids'</span>]]),token_type_ids = torch.tensor([token_codes[<span class="string">'token_type_ids'</span>]]))</span><br><span class="line"><span class="comment"># outputs[0]为logits，outputs[1]为hidden</span></span><br></pre></td></tr></table></figure>
<p>输出的转化可直接通过numpy的argmax函数实现。</p>
<h3 id="其他的任务，将继续更新"><a href="#其他的任务，将继续更新" class="headerlink" title="其他的任务，将继续更新"></a>其他的任务，将继续更新</h3><p>其他的模型和之前的两个大致是相同的，你可以自己发挥。我会继续在相关的库上进行实验，如果发现用法不一样的情况，将会添加在这里。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>本文章主要对HuggingFace库进行了简要介绍。具体安装等过程请参见官方<a href="https://github.com/huggingface/transformers" target="_blank" rel="noopener">github仓库</a>。</p>
<p>本文主要参考于<a href="https://huggingface.co/transformers/installation.html#" target="_blank" rel="noopener">官方文档</a></p>
<p>同时，在模型的理解过程中参考了一些kaggle上的notebooks, <a href="https://www.kaggle.com/abhishek/bert-base-uncased-using-pytorch" target="_blank" rel="noopener">主要是这一篇</a>，作者是<a href="https://www.kaggle.com/abhishek" target="_blank" rel="noopener">Abhishek Thakur</a></p>
<h1 id="修改记录"><a href="#修改记录" class="headerlink" title="修改记录"></a>修改记录</h1><ul>
<li>2020/5/4 <ul>
<li>添加不同模型需要的分词格式变化</li>
<li>增改论文链接</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2021/02/18/Android%E5%B1%8F%E5%B9%95%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/18/Android%E5%B1%8F%E5%B9%95%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Android屏幕绘制原理</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-18 08:49:40" itemprop="dateCreated datePublished" datetime="2021-02-18T08:49:40+08:00">2021-02-18</time>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/12/09/java%E9%9C%80%E8%A6%81%E8%AE%B0%E4%BD%8F%E7%9A%84%E5%87%A0%E4%BB%B6%E4%BA%8B%E5%84%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/09/java%E9%9C%80%E8%A6%81%E8%AE%B0%E4%BD%8F%E7%9A%84%E5%87%A0%E4%BB%B6%E4%BA%8B%E5%84%BF/" class="post-title-link" itemprop="url">Java需要记住的几件事儿</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-09 15:53:04" itemprop="dateCreated datePublished" datetime="2020-12-09T15:53:04+08:00">2020-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-13 22:22:26" itemprop="dateModified" datetime="2020-12-13T22:22:26+08:00">2020-12-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="继承篇"><a href="#继承篇" class="headerlink" title="继承篇"></a>继承篇</h1><h2 id="新建对象时，引用必须比new对象的等级高"><a href="#新建对象时，引用必须比new对象的等级高" class="headerlink" title="新建对象时，引用必须比new对象的等级高"></a>新建对象时，引用必须比new对象的等级高</h2><ul>
<li>新建对象时，包含两部分，一部分是new出来的对象，一部分是创建的新引用。引用的类型可以是接口、抽象类、普通类，而new对象的类型必须是<strong>实现类</strong>，这个实现类常见的有三种表现形式，一种是普通的类，另外是抽象类或接口，但是必须实现所有还没有实现的方法。引用的类型可以使用new出来对象的父类，但是不能使用其子类。可以这样理解：引用的作用是调用方法，子类往往拥有比父类更多的方法（通过继承多个接口等），因此只能用方法更少的父类指向方法更多的子类，以防我们引用了某个方法，但是在new出来的对象中并不存在，造成错误。</li>
</ul>
<h2 id="cast对象时，需要从子类cast为父类-需要从内存中实际对象的类别转化为其父类或本身"><a href="#cast对象时，需要从子类cast为父类-需要从内存中实际对象的类别转化为其父类或本身" class="headerlink" title="cast对象时，需要从子类cast为父类 需要从内存中实际对象的类别转化为其父类或本身"></a>cast对象时，<del>需要从子类cast为父类</del> 需要从内存中实际对象的类别转化为其父类或本身</h2><ul>
<li>和上面的一条有异曲同工之妙，在类型强转之后，我们需要调用对象中的方法，强转的过程想必也不会添加新的方法吧。所以强转是不是可以看作是单纯地去掉一些方法呢，其实不是的。强转的最大作用其实是让我们用不同的引用类型去访问同一个对象，而<strong>堆中的对象本身并没有改变</strong>。</li>
<li>但是，在安卓开发中经常会用到 (Button) findViewById(R.id.activity_button) 这样的操作，而Button明明是子类啊，为什么可以强转呢？区别在于引用指向的对象在内存中究竟是什么。如果其在内存中是以Button存在的，那么即使返回类型是以View引用的，也可以强转回Button。</li>
</ul>
<h2 id="子类override父类的方法时，可以改变方法的返回值，但是返回值必须是父类返回值的子类"><a href="#子类override父类的方法时，可以改变方法的返回值，但是返回值必须是父类返回值的子类" class="headerlink" title="子类override父类的方法时，可以改变方法的返回值，但是返回值必须是父类返回值的子类"></a>子类override父类的方法时，可以改变方法的返回值，但是返回值必须是父类返回值的子类</h2><ul>
<li>还是和引用与实现对象的类型有关。在调用方法时，利用的是引用的类型，即父类。如果引用类型中没有某个方法，就无法调用，即使实现对象中有此方法。所以父类方法的<strong>返回类型</strong>就是我们调用方法时期望得到的类型。我们可能会利用一个<strong>返回值引用</strong>去指向得到的返回值。所以由<strong>“新建对象时，引用必须比new对象的等级高”</strong>可知，返回值引用的类型要比返回对象的等级高，如果子类实现返回一个等级更高的对象，就可能违背这个原则。</li>
</ul>
<h2 id="方法中实际返回的类型要比声明的类型等级低"><a href="#方法中实际返回的类型要比声明的类型等级低" class="headerlink" title="方法中实际返回的类型要比声明的类型等级低"></a>方法中实际返回的类型要比声明的类型等级低</h2><ul>
<li>由原则1,2易得</li>
</ul>
<h1 id="运行篇"><a href="#运行篇" class="headerlink" title="运行篇"></a>运行篇</h1><h2 id="守护线程和用户线程"><a href="#守护线程和用户线程" class="headerlink" title="守护线程和用户线程"></a>守护线程和用户线程</h2><p>在java程序开始执行之后，会产生多个线程。主要分为用户线程和守护线程。用户线程包括我们平时使用的main函数创建的主线程，这个线程主要完成一些复杂的工作，而守护线程则是为了程序正常运行提供服务的线程。他们主要有以下区别：</p>
<h3 id="jvm只等待用户线程结束才结束"><a href="#jvm只等待用户线程结束才结束" class="headerlink" title="jvm只等待用户线程结束才结束"></a>jvm只等待用户线程结束才结束</h3><h3 id="用户线程优先级比守护线程高"><a href="#用户线程优先级比守护线程高" class="headerlink" title="用户线程优先级比守护线程高"></a>用户线程优先级比守护线程高</h3><p>这保证了cpu会优先满足用户进程的执行</p>
<h3 id="由谁创建：用户线程通常由用户创建，而守护线程往往由操作系统创建"><a href="#由谁创建：用户线程通常由用户创建，而守护线程往往由操作系统创建" class="headerlink" title="由谁创建：用户线程通常由用户创建，而守护线程往往由操作系统创建"></a>由谁创建：用户线程通常由用户创建，而守护线程往往由操作系统创建</h3><h3 id="用户线程是jvm运行的前提，当只有守护线程时，jvm无法继续运行"><a href="#用户线程是jvm运行的前提，当只有守护线程时，jvm无法继续运行" class="headerlink" title="用户线程是jvm运行的前提，当只有守护线程时，jvm无法继续运行"></a>用户线程是jvm运行的前提，当只有守护线程时，jvm无法继续运行</h3><h2 id="栈帧的组成"><a href="#栈帧的组成" class="headerlink" title="栈帧的组成"></a>栈帧的组成</h2><p>Each frame contains:</p>
<h3 id="Local-variable-array-本地变量数组"><a href="#Local-variable-array-本地变量数组" class="headerlink" title="Local variable array 本地变量数组"></a>Local variable array 本地变量数组</h3><ul>
<li>boolean</li>
<li>byte</li>
<li>char</li>
<li>long</li>
<li>short</li>
<li>int</li>
<li>float</li>
<li>double</li>
<li>reference</li>
<li>returnAddress</li>
</ul>
<p>除了double和float之外，都占用8个字节/32bit</p>
<h3 id="Return-value-返回值"><a href="#Return-value-返回值" class="headerlink" title="Return value 返回值"></a>Return value 返回值</h3><h3 id="Operand-stack-操作数栈"><a href="#Operand-stack-操作数栈" class="headerlink" title="Operand stack 操作数栈"></a>Operand stack 操作数栈</h3><h3 id="Reference-to-runtime-constant-pool-for-class-of-the-current-method-运行时常量池的引用"><a href="#Reference-to-runtime-constant-pool-for-class-of-the-current-method-运行时常量池的引用" class="headerlink" title="Reference to runtime constant pool for class of the current method 运行时常量池的引用"></a>Reference to runtime constant pool for class of the current method 运行时常量池的引用</h3><h3 id="运行时常量池的作用"><a href="#运行时常量池的作用" class="headerlink" title="运行时常量池的作用"></a>运行时常量池的作用</h3><p>在c(++)语言中，代码通常被编译为一个个对象，然后通过连接他们来产生可运行文件或者dll。在连接阶段，符号引用被实际的内存地址代替。而在java中这个过程是在运行时动态实现的。</p>
<p>当java class被加载到jvm中之后，所有的引用和变量都会被存储在类的常量池中，这里的存储使用的是符号引用，而不是对应于实际的地址引用。jvm的具体实现可以选择何时解析符号引用，分为两种，饥饿模式和懒汉模式。饥饿模式的解析发生在字节码验证之后，懒汉模式则发生在引用和变量第一次被使用时。Binding是变量、方法的符号引用被直接引用取代的过程，这个过程只发生一次。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/12/08/java%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E4%B8%8E%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/08/java%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E4%B8%8E%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Java内存泄漏与性能分析</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-08 19:56:17" itemprop="dateCreated datePublished" datetime="2020-12-08T19:56:17+08:00">2020-12-08</time>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/12/08/java%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D-JNI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/08/java%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D-JNI/" class="post-title-link" itemprop="url">java本地方法介绍(JNI)</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-08 16:05:34 / 修改时间：18:08:04" itemprop="dateCreated datePublished" datetime="2020-12-08T16:05:34+08:00">2020-12-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h1><p>这篇博客将对java中的本地方法进行介绍，主要从为什么需要本地方法，以及本地方法是如何运行的两个方面进行。</p>
<h1 id="为什么需要本地方法"><a href="#为什么需要本地方法" class="headerlink" title="为什么需要本地方法"></a>为什么需要本地方法</h1><p>java的跨平台特性是其一大优点，我们通过一次编译得到字节码，就能在任何可以运行jvm（Java Virtual Machine）的系统上执行。然而，在有些情况下，我们可能需要一些纯java代码无法实现的功能，这时我们需要一些在本地编译好，只能在特定环境下执行的代码，也就是本地方法，本地方法常常由C/C++语言编写。</p>
<p>需要使用本地方法的情况主要有以下三种：</p>
<ol>
<li>需要和硬件进行交互</li>
<li>对于有些方法，使用C/C++可以加快执行的速度，因为C/C++的编译是依赖于操作系统的，对于程序性能有要求的可以考虑使用本地方法。</li>
<li>有些库已经用其他语言写好，我们想使用但是不想重新再写一遍的话，就可以使用本地方法。</li>
</ol>
<p>java代码是在 jvm中运行的， 本地方法是在本地环境中运行的，为了在java程序中调用本地方法，就需要一个桥梁将本地方法和jvm连接起来，这个桥梁就是JNI(java native interface)。</p>
<h1 id="本地方法是如何运行的"><a href="#本地方法是如何运行的" class="headerlink" title="本地方法是如何运行的"></a>本地方法是如何运行的</h1><p>java关键字<code>native</code> 表明某个接口是由本地代码实现的。</p>
<p>java调用C/C++代码的时候，使用的是动态链接库的方式（shared libs），因为我们不能把字节码和本地编译好的代码放在同一个二进制文件中（jvm无法执行本地代码）。因此，最终编译好的java代码只声明对本地代码的<strong>引用</strong>， 而不是直接把代码复制过来。所以引用的库中会包含<em>so/.dll/.dylib</em>等文件，操作系统不同，文件的格式也不同。</p>
<p>本地方法也是一种抽象方法, 我们只是声明方法头， 具体的实现则交给本地代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">aNativeMethod</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>要实现本地方法的运行，主要需要以下组件：</p>
<ul>
<li>Java Code – our classes. They will include at least one <em>native</em> method.</li>
<li>Native Code – the actual logic of our native methods, usually coded in C or C++.</li>
<li>JNI header file – this header file for C/C++ (<em>include/jni.h</em> into the JDK directory) includes all definitions of JNI elements that we may use into our native programs.</li>
<li>C/C++ Compiler – we can choose between GCC, Clang, Visual Studio, or any other we like as far as it’s able to generate a native shared library for our platform.</li>
</ul>
<h2 id="本地方法代码编写步骤"><a href="#本地方法代码编写步骤" class="headerlink" title="本地方法代码编写步骤"></a>本地方法代码编写步骤</h2><h3 id="创建java类，其中声明本地方法"><a href="#创建java类，其中声明本地方法" class="headerlink" title="创建java类，其中声明本地方法"></a>创建java类，其中声明本地方法</h3><h3 id="利用Java编译器（javac）的-h选项创建方法的引用，-h文件"><a href="#利用Java编译器（javac）的-h选项创建方法的引用，-h文件" class="headerlink" title="利用Java编译器（javac）的-h选项创建方法的引用，.h文件"></a>利用Java编译器（javac）的-h选项创建方法的引用，.h文件</h3><h3 id="创建-cpp文件，实现本地代码"><a href="#创建-cpp文件，实现本地代码" class="headerlink" title="创建.cpp文件，实现本地代码"></a>创建.cpp文件，实现本地代码</h3><h3 id="编译并链接"><a href="#编译并链接" class="headerlink" title="编译并链接"></a>编译并链接</h3><p><strong>编译C++代码：</strong></p>
<p>Ubuntu version:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -c -fPIC -I<span class="variable">$&#123;JAVA_HOME&#125;</span>/include -I<span class="variable">$&#123;JAVA_HOME&#125;</span>/include/linux com_baeldung_jni_HelloWorldJNI.cpp -o com_baeldung_jni_HelloWorldJNI.o</span><br></pre></td></tr></table></figure>
<p>Windows version:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -c -I%JAVA_HOME%\include -I%JAVA_HOME%\include\win32 com_baeldung_jni_HelloWorldJNI.cpp -o com_baeldung_jni_HelloWorldJNI.o</span><br></pre></td></tr></table></figure>
<p>MacOS version;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -c -fPIC -I<span class="variable">$&#123;JAVA_HOME&#125;</span>/include -I<span class="variable">$&#123;JAVA_HOME&#125;</span>/include/darwin com_baeldung_jni_HelloWorldJNI.cpp -o com_baeldung_jni_HelloWorldJNI.o</span><br></pre></td></tr></table></figure>
<p><strong>和java共享库建立链接：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -shared -fPIC -o libnative.so com_baeldung_jni_HelloWorldJNI.o -lc</span><br></pre></td></tr></table></figure>
<p>Windows version:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -shared -o native.dll com_baeldung_jni_HelloWorldJNI.o -Wl,--add-stdcall-alias</span><br></pre></td></tr></table></figure>
<p>MacOS version:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -dynamiclib -o libnative.dylib com_baeldung_jni_HelloWorldJNI.o -lc</span><br></pre></td></tr></table></figure>
<h3 id="在命令行中执行"><a href="#在命令行中执行" class="headerlink" title="在命令行中执行"></a>在命令行中执行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp . -Djava.library.path=/NATIVE_SHARED_LIB_FOLDER com.baeldung.jni.HelloWorldJNI</span><br></pre></td></tr></table></figure>
<p>除此之外，java与本地方法之间还可以传递参数，参数类型是通过JNIEnv进行映射的，<a href="https://docs.oracle.com/javase/9/docs/specs/jni/types.html" target="_blank" rel="noopener">映射表的链接</a>。 </p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://www.baeldung.com/jni" target="_blank" rel="noopener">https://www.baeldung.com/jni</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/11/29/TIMESAVER%E7%9A%84%E6%BC%94%E5%8C%96%E5%8F%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/29/TIMESAVER%E7%9A%84%E6%BC%94%E5%8C%96%E5%8F%B2/" class="post-title-link" itemprop="url">TIMESAVER的演化史</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-29 20:56:27 / 修改时间：22:38:50" itemprop="dateCreated datePublished" datetime="2020-11-29T20:56:27+08:00">2020-11-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><p>我是一名NBA球迷，上大学后时间都由自己支配了，因此将更多的时间花在追星这件事上。而对于篮球迷来说，虎扑则是大家一起交流娱乐的乐园。在大多数无聊的时候，我会打开虎扑网页或者APP版，查看有关詹姆斯的信息。而且我只关注他一个人，别人的消息我都直接划过，甚至对我来说是浪费时间，因此萌生了 使用爬虫过滤信息的方法。</p>
<h2 id="爬虫-EXCEL阅读"><a href="#爬虫-EXCEL阅读" class="headerlink" title="爬虫+EXCEL阅读"></a>爬虫+EXCEL阅读</h2><p><img src="\images\TIMESAVER的演化史\image-20201129210419725.png" alt="image-20201129210419725" style="zoom:50%;" /></p>
<p><img src="\images\TIMESAVER的演化史\image-20201129210601902.png" alt="image-20201129210601902" style="zoom:60%;" /></p>
<p>实现的唯一功能是爬取湿乎乎的话题这一板块的所有数据，然后过滤得到标题中包含詹姆斯的结果，最终将链接也一并返回。</p>
<p>需求大致是实现了，一开始用的也很起劲。但是，每次阅读之前我都需要打开Pycharm, 等爬取结束之后再打开EXCEL，这中间的步骤太多，以致大多数情况下，我都不愿意，也可能不记得使用这个工具。久而久之，写好的代码就被我闲置了。最近开始学习安卓开发，就萌生了将这个功能部署在云服务器，然后写一个APP来展示数据的想法，写这个应用的初衷是节约时间，故名曰：TIMESAVER。</p>
<h1 id="版本迭代"><a href="#版本迭代" class="headerlink" title="版本迭代"></a>版本迭代</h1><h2 id="v1-0"><a href="#v1-0" class="headerlink" title="v1.0"></a>v1.0</h2><p>首页：</p>
<p><img src="\images\TIMESAVER的演化史\image-20201129221653452.png" alt="image-20201129221653452" style="zoom:67%;" /></p>
<p>点击获取之后，会进入<strong>等待</strong>状态，同时会向云服务器发送请求，云服务器实时爬取之后将结果返回到客户端。</p>
<p><img src="\images\TIMESAVER的演化史\image-20201129221805801.png" alt="image-20201129221805801" style="zoom:67%;" /></p>
<p>返回的数据直接放入TextView进行展示，展示效果如图：</p>
<p><img src="\images\TIMESAVER的演化史\image-20201129221944630.png" alt="image-20201129221944630" style="zoom:67%;" /></p>
<h2 id="v2-0"><a href="#v2-0" class="headerlink" title="v2.0"></a>v2.0</h2><p>最近新学习了ListView, 通过ListView可以自定义每一项的显示，相对来说自由度比较高，可以获得更加美观的结果。除此之外, ListView还自带滚动效果，省去了调整ScrollView的困难（在v1.0的实现中需要使用ScrollView, 其宽度和长度的属性设置曾产生了难以解释的结果，导致我最后只能通过硬编码的方式解决布局问题）。</p>
<p>通过菜单栏切换到列表模式：</p>
<p><img src="\images\TIMESAVER的演化史\image-20201129222756210.png" alt="image-20201129222756210" style="zoom:67%;" /></p>
<p>还是相同的操作，点击获取，等待……最终得到结果：</p>
<p><img src="\images\TIMESAVER的演化史\image-20201129222848423.png" alt="image-20201129222848423" style="zoom:67%;" /></p>
<p>肉眼可见的两点改进：</p>
<ul>
<li>不同新闻之间可以添加分割线，更加明确区分的界限。</li>
<li>可以在标题前添加序号，方便计数与识别。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dxzmpk.github.io/2020/11/22/%E5%AE%89%E5%8D%93%E4%B8%ADFragment%E3%80%81Activity%E3%80%81View%E3%80%81Layout%E7%9A%84%E5%85%B3%E7%B3%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="董雄">
      <meta itemprop="description" content="Learning in Harbin Institute of Technology">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董雄写字的地方">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/%E5%AE%89%E5%8D%93%E4%B8%ADFragment%E3%80%81Activity%E3%80%81View%E3%80%81Layout%E7%9A%84%E5%85%B3%E7%B3%BB/" class="post-title-link" itemprop="url">安卓中Fragment、Activity、View、Layout的关系</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 16:45:35" itemprop="dateCreated datePublished" datetime="2020-11-22T16:45:35+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-26 15:06:17" itemprop="dateModified" datetime="2020-11-26T15:06:17+08:00">2020-11-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/process/a.svg" alt="未命名文件"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">董雄</p>
  <div class="site-description" itemprop="description">Learning in Harbin Institute of Technology</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">董雄</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1278837449&web_id=1278837449"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 't8n8RTilca5Gm0vKToaMrjRU-gzGzoHsz',
      appKey     : 'x4Jty8MrDpczjPANtbbGhwXX',
      placeholder: "请留下一点痕迹吧, 评论将永远留存",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
